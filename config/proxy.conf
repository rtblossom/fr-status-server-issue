#######################################################################
#
#  Configuration for the proxy realms.
#
#  As of 2.0, the "realm" configuration has changed.  Instead of
#  specifying "authhost" and "accthost" in a realm section, the home
#  servers are specified separately in a "home_server" section.  For
#  backwards compatibility, you can still use the "authhost" and
#  "accthost" directives.  If you only have one home server for a
#  realm, it is easier to use the old-style configuration.
#
#  However, if you have multiple servers for a realm, we STRONGLY
#  suggest moving to the new-style configuration.
#
#
#  Load-balancing and failover between home servers is handled via
#  a "home_server_pool" section.
#
#  Finally, The "realm" section defines the realm, some options, and
#  indicates which server pool should be used for the realm.
#
#  This change means that simple configurations now require multiple
#  sections to define a realm.  However, complex configurations
#  are much simpler than before, as multiple realms can share the same
#  server pool.
#
#  That is, realms point to server pools, and server pools point to
#  home servers.  Multiple realms can point to one server pool.  One
#  server pool can point to multiple home servers.  Each home server
#  can appear in one or more pools.
#
#  See sites-available/tls for an example of configuring home servers,
#  pools, and realms with TLS.
#

######################################################################
#
#  This section defines a "Home Server" which is another RADIUS
#  server that gets sent proxied requests.  In earlier versions
#  of FreeRADIUS, home servers were defined in "realm" sections,
#  which was awkward.  In 2.0, they have been made independent
#  from realms, which is better for a number of reasons.
#

# Send to NGINX to be proxied to non-failover upstream
home_server hub_radsec_no_failover_1 {
    type =  auth+acct
    ipaddr = $ENV{RADSEC_HOST1}
    port = 2082
    secret = radsec
    proto = tcp
    status_check = none
    response_window = 10
    limit {
        max_connections = 128
        lifetime = 0
        idle-timeout = 0
    }
    tls {
        tls_min_version = "1.2"
        private_key_file = $ENV{CLIENT_KEY_LOCATION}
        certificate_file = $ENV{CLIENT_CRT_LOCATION}
        ca_file = ${CA_CRT_LOCATION}
        fragment_size = 8192
    }
}

# Send to NGINX to be proxied to non-failover upstream
home_server hub_radsec_no_failover_2 {
    type =  auth+acct
    ipaddr = $ENV{RADSEC_HOST2}
    port = 2082
    secret = radsec
    proto = tcp
    status_check = none
    response_window = 10
    limit {
        max_connections = 128
        lifetime = 0
        idle-timeout = 0
    }
    tls {
        tls_min_version = "1.2"
        private_key_file = $ENV{CLIENT_KEY_LOCATION}
        certificate_file = $ENV{CLIENT_CRT_LOCATION}
        ca_file = ${CA_CRT_LOCATION}
        fragment_size = 8192
    }
}


#  When a request is proxied to a TLS-enabled home server,
#  the TLS parameters are available via the expansion:
#
#	%{proxy_listen: ... }
#
#  The contents of the expansion are the same as described
#  above with the %{listen: ... } expansion, and have similar
#  meanings.  "client" in this case is the proxy (this system)
#  and "server" is the remote system (home server).
#
#  Note that the %{proxy_listen: ... } parameters are available
#  only AFTER the connection has been made to the home server.
#

home_server_pool hub_radsec_no_failover_1_pool {
	type = fail-over
	home_server = hub_radsec_no_failover_1
	nostrip
}

home_server_pool hub_radsec_no_failover_2_pool {
	type = fail-over
	home_server = hub_radsec_no_failover_2
	nostrip
}

#Proxy-To-Realm to force proxying to az1 over RadSec
realm DIRECT_HUB_RADSEC1 {
	auth_pool = hub_radsec_no_failover_1_pool
	acct_pool = hub_radsec_no_failover_1_pool
	nostrip
}

#Proxy-To-Realm to force proxying to az2 over RadSec
realm DIRECT_HUB_RADSEC2 {
	auth_pool = hub_radsec_no_failover_2_pool
	acct_pool = hub_radsec_no_failover_2_pool
	nostrip
}

#Standard Proxy-To-Realm for hub RadSec traffic
realm HUB_RADSEC {
	auth_pool = hub_radsec_pool
	acct_pool = hub_radsec_pool
	nostrip
}

#Proxy all undefined realms to hub over RadSec.
#Add individual realms to this config to send to other servers.
realm DEFAULT {
	auth_pool = hub_radsec_pool
	acct_pool = hub_radsec_pool
	nostrip
}


